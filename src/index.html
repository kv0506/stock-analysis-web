<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Stock Analysis</title>
  <base href="/" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script
          type="text/javascript"
          src="https://s3.tradingview.com/tv.js"
  ></script>
  <link
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
          rel="stylesheet"
          integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD"
          crossorigin="anonymous"
  />
  <script
          src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN"
          crossorigin="anonymous"
  ></script>
  <script src="https://code.jquery.com/jquery-1.9.1.min.js"></script>
</head>
<body>
<div id="mainContainer" class="container-fluid">
  <div class="card bg-primary text-white m-3">
    <div class="card-body">
      <div class="row">
        <div class="col-sm-3 text-start">
          <h5>Stock Analysis</h5>
        </div>
        <div id="nifty-50" class="col-sm-3"></div>
        <div id="nifty-bank" class="col-sm-3"></div>
        <div class="col-sm-3">
          <select id="users" class="form-select"></select>
        </div>
      </div>
    </div>
  </div>
  <div id="chartsContainer" class="p-3"></div>
</div>
<script>
  var chartWidth = 540; // default chart width
  var columnCount = 1; // default column count
  var bootstrapColumnClass = "col-sm-12";
  var symbolCollection = [];

  $(document).ready(function () {
    calculateColumnValues();
    initializeSymbolCollection();
    loadNiftyTicker();
  });

  function calculateColumnValues() {
    var screenWidth = Math.floor($(window).width()) - 50;
    var possibleColumnCount = Math.floor(screenWidth / chartWidth);
    var colWidth = Math.floor(screenWidth / possibleColumnCount);

    if (colWidth > chartWidth) {
      chartWidth = colWidth;
    } else if (screenWidth < chartWidth) {
      chartWidth = screenWidth;
    }

    columnCount = Math.floor(screenWidth / chartWidth);

    if (columnCount > 1) {
      var bootstrapColumnSize = 12 / columnCount;
      bootstrapColumnClass = `col-${bootstrapColumnSize}`;
    }
  }

  function createWidgets(symbols) {
    var currentColumnNumber = 0;
    var currentRowNumber = 1;

    $("#chartsContainer").empty();

    for (var i = 0; i < symbols.length; i++) {
      if (currentColumnNumber === 0) {
        var newRow = `<div id='row-${currentRowNumber}' class="row mb-3"></div>`;
        $("#chartsContainer").append(newRow);
      }

      var newColumn = `<div id='container-${symbols[i]}' class='${bootstrapColumnClass}'></div>`;
      $(`#row-${currentRowNumber}`).append(newColumn);
      loadWidget(symbols[i], `container-${symbols[i]}`);
      currentColumnNumber++;

      if (currentColumnNumber >= columnCount) {
        currentColumnNumber = 0;
        currentRowNumber++;
      }
    }
  }

  function loadWidget(symbol, container) {
    new TradingView.widget({
      width: chartWidth,
      symbol: `BSE:${symbol}`,
      interval: "D",
      timezone: "Asia/Kolkata",
      theme: "light",
      style: "1",
      locale: "en",
      toolbar_bg: "#f1f3f6",
      enable_publishing: false,
      withdateranges: true,
      hide_side_toolbar: false,
      allow_symbol_change: true,
      studies: [
        {
          id: "MAExp@tv-basicstudies",
          version: 60,
          inputs: {
            length: 50,
          },
        },
        {
          id: "MAExp@tv-basicstudies",
          version: 60,
          inputs: {
            length: 100,
          },
        },
        {
          id: "MACD@tv-basicstudies",
        },
      ],
      studies_overrides: {
        "macd.macd.color": "#008000",
        "macd.signal.color": "#FF0000",
        "macd.macd.linewidth": 2,
        "macd.signal.linewidth": 2,
        "ema.ma.linewidth": 2,
        "ema.ma.color.0": "#008000",
        "ema.ma.color.1": "#FF0000",
      },
      container_id: `container-${symbol}`,
    });
  }

  function initializeSymbolCollection() {
    $.ajax({
      url: "https://stock-analysis.azurewebsites.net/api/users",
      success: function (response) {
        symbolCollection = response.users;
        loadUsers();
      },
    });
  }

  function loadUsers() {
    $("#users").append($("<option />").text("Select a user").val(""));
    symbolCollection.forEach((item) => {
      $("#users").append($("<option />").text(item.name).val(item.name));
    });

    $("#users").change(function () {
      var selectedUser = $("#users").val();
      if (selectedUser) {
        var userSymbols = symbolCollection.find(
                (x) => x.name === selectedUser
        );
        if (userSymbols) {
          createWidgets(userSymbols.symbols);
        }
      }
    });
  }

  function loadNiftyTicker() {
    createNiftyTickets();
    setInterval(function () {
      if (isMarketOpen()) {
        createNiftyTickets();
      }
    }, 60000);
  }

  function isMarketOpen() {
    var now = new Date();
    var day = now.getDay();
    var hour = now.getHours();
    if (day > 0 && day < 6 && hour >= 9 && hour < 16) {
      return true;
    }
    return false;
  }

  function createNiftyTickets() {
    $("#nifty-50").empty();
    $("#nifty-bank").empty();
    $.ajax({
      url: "https://stock-analysis.azurewebsites.net/api/live-market",
      success: function (response) {
        response.result.forEach((item) => {
          var html = `<div class='${
                  item.change > 0 ? "bg-success" : "bg-danger"
          } p-2 rounded'>
                <div class="d-flex">
                  <div class="fs-5">${item.name}</div>
                  <div class="ms-auto fs-5">${item.current} (${
                  item.change
          }%)</div>
                </div>
                Advances : ${item.advances}&nbsp; &nbsp; Declines : ${
                  item.declines
          }&nbsp; &nbsp; Unchanged : ${item.unchanged}
              </div>`;
          if (item.name == "NIFTY 50") {
            $("#nifty-50").append(html);
          } else {
            $("#nifty-bank").append(html);
          }
        });
      },
    });
  }
</script>
</body>
</html>
